{% extends 'base.html' %}
{% load user_tags %}
{% block title %} Â· Messages{% endblock %}

{% block extra_head %}
<style>
    /* Hide Django messages popup on messages page */
    .page-body > .alert {
        display: none !important;
    }
    
    /* Ensure hamburger menu button is always accessible */
    .toggle-sidebar-btn,
    #sidebarToggle {
        z-index: 1002 !important;
        pointer-events: auto !important;
        position: fixed !important;
    }
    
    /* Ensure messages page doesn't block the hamburger button */
    .messages-page,
    .messages-container {
        position: relative;
        z-index: 0;
    }
    
    /* Prevent page body from scrolling */
    body.messages-page-active {
        overflow: hidden !important;
        height: 100vh !important;
    }
    
    /* Prevent page-body wrapper from scrolling */
    .page-body {
        overflow: hidden !important;
        height: 100vh !important;
    }
</style>
{% endblock %}

{% block content %}
<style>
/* Main Container */


.messages-container {
    max-width: 1800px;
    width: 100%;
    margin: 0 auto;
    display: grid;
    grid-template-columns: 420px 1fr;
    height: calc(100vh - 116px);
    min-height: 400px;
    max-height: calc(1050px);
    background: var(--card, white);
    border-radius: 24px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
    border: 1px solid var(--border, #e5e7eb);
    position: relative;
    z-index: 0;
    box-sizing: border-box;
}

/* Conversations Sidebar */
.conversations-sidebar {
    border-right: 2px solid var(--border, #f3f4f6);
    display: flex;
    flex-direction: column;
    background: var(--background, #fafbfc);
}

.conversations-header {
    padding: 28px 24px;
    border-bottom: 2px solid var(--border, #f3f4f6);
    background: var(--card, white);
}

.conversations-header h2 {
    margin: 0;
    font-size: 28px;
    font-weight: 900;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: -0.5px;
}

.conversations-list {
    overflow-y: auto;
    flex: 1;
    padding: 8px;
}

/* Swipeable conversation container */
.conversation-swipe-wrapper {
    position: relative;
    margin-bottom: 4px;
    overflow: hidden;
    border-radius: 12px;
}

.conversation-item {
    padding: 16px;
    border-radius: 12px;
    cursor: pointer;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), border-color 0.2s ease;
    text-decoration: none;
    color: inherit;
    display: block;
    border: 2px solid transparent;
    background: var(--card, white);
    position: relative;
    z-index: 2;
    touch-action: pan-y;
    user-select: none;
}

.conversation-item.swiping {
    transition: none;
}

.conversation-item:hover:not(.swiping):not([style*="translateX"]) {
    border-color: #e5e7eb;
}

.conversation-item.active {
    background: var(--card, white);
    border-color: #667eea;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    position: relative;
}

.conversation-item.active::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
    pointer-events: none;
    border-radius: 12px;
}

/* Action buttons revealed on swipe */
.conversation-actions {
    position: absolute;
    right: 0;
    top: 0;
    bottom: 0;
    display: flex;
    align-items: center;
    gap: 0;
    z-index: 1;
    padding-right: 8px;
}

.conversation-action-btn {
    height: 100%;
    min-width: 85px;
    width: 85px;
    border: none;
    cursor: pointer;
    font-weight: 700;
    font-size: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 2px;
    transition: all 0.2s ease;
    padding: 8px 4px;
    flex-direction: column;
    text-align: center;
    line-height: 1.2;
}

.conversation-action-btn > span:first-child {
    display: block;
    font-size: 20px;
    line-height: 1;
    margin-bottom: 2px;
}

.conversation-action-btn > span:last-child {
    display: block;
    font-size: 10px;
    line-height: 1.1;
}

.conversation-action-btn.archive-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.conversation-action-btn.archive-btn:hover {
    background: linear-gradient(135deg, #5a77ff 0%, #6a3f9f 100%);
}

.conversation-action-btn.unarchive-btn {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
}

.conversation-action-btn.unarchive-btn:hover {
    background: linear-gradient(135deg, #059669 0%, #047857 100%);
}

.conversation-action-btn.delete-btn {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.conversation-action-btn.delete-btn:hover {
    background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
}

.conversation-user {
    display: flex;
    align-items: center;
    gap: 12px;
}

.conversation-avatar {
    width: 52px;
    height: 52px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    overflow: hidden;
}

.conversation-info {
    flex: 1;
    min-width: 0;
}

.conversation-name {
    font-weight: 700;
    font-size: 15px;
    color: var(--text, #111827);
    margin-bottom: 4px;
}

.conversation-preview {
    font-size: 13px;
    color: var(--text-light, #6b7280);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    font-weight: 500;
}

.conversation-meta {
    text-align: right;
    align-self: flex-start;
}

.conversation-time {
    font-size: 11px;
    color: var(--text-light, #9ca3af);
    font-weight: 600;
    margin-bottom: 4px;
}

.unread-badge {
    display: inline-block;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    padding: 3px 10px;
    font-size: 11px;
    font-weight: 800;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
}

.empty-state {
    padding: 60px 20px;
    text-align: center;
}

.empty-state-icon {
    font-size: 56px;
    margin-bottom: 20px;
    opacity: 0.3;
}

.empty-state-icon i {
    font-size: 56px;
}

.empty-state p {
    color: var(--text-light, #6b7280);
    font-size: 15px;
    font-weight: 500;
}

/* Chat Area */
.chat-area {
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
    background: var(--card, white);
}

.chat-header {
    padding: 24px 32px;
    border-bottom: 2px solid var(--border, #f3f4f6);
    background: var(--card, white);
}

.chat-user-info {
    display: flex;
    align-items: center;
    gap: 16px;
}

.chat-avatar {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    overflow: hidden;
}

.chat-user-details {
    flex: 1;
}

.chat-user-name {
    font-weight: 800;
    font-size: 18px;
    color: var(--text, #111827);
    margin-bottom: 2px;
}

.chat-user-username {
    font-size: 14px;
    color: #667eea;
    font-weight: 600;
}

/* Messages Area */
.messages-area {
    flex: 1;
    overflow-y: auto;
    padding: 32px;
    background: var(--background, #f9fafb);
    min-height: 0;
}

.message {
    display: flex;
    margin-bottom: 20px;
    animation: slideUp 0.3s ease;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

.message.sent {
    justify-content: flex-end;
}

.message-bubble {
    max-width: 80%;
    padding: 14px 18px;
    border-radius: 16px;
    position: relative;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

.message.received .message-bubble {
    background: var(--card, white);
    border-bottom-left-radius: 4px;
    border: 1px solid var(--border, #e5e7eb);
    color: var(--text, #111827);
}

.message.sent .message-bubble {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-bottom-right-radius: 4px;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
}

.message-content {
    word-wrap: break-word;
    line-height: 1.6;
    font-size: 15px;
    font-weight: 500;
}

.message.sent .message-content {
    color: white;
}

.message-time {
    font-size: 11px;
    margin-top: 6px;
    opacity: 0.7;
    font-weight: 600;
}

.no-messages {
    text-align: center;
    color: var(--text-light, #9ca3af);
    margin-top: 60px;
}

.no-messages-icon {
    font-size: 64px;
    margin-bottom: 16px;
    opacity: 0.3;
}

.no-messages-icon i {
    font-size: 64px;
}

.no-messages p {
    font-size: 16px;
    font-weight: 600;
}

/* Message Input Area */
.message-input-area {
    padding: 24px 32px;
    border-top: 2px solid var(--border, #f3f4f6);
    background: var(--card, white);
    flex-shrink: 0;
}

.message-form {
    display: flex;
    gap: 12px;
    align-items: center;
}

.message-input {
    flex: 1;
    padding: 14px 20px;
    border: 2px solid var(--border, #e5e7eb);
    border-radius: 16px;
    outline: none;
    font-size: 15px;
    font-family: inherit;
    transition: all 0.2s ease;
    background: var(--background, #f9fafb);
    font-weight: 500;
    color: var(--text, #111827);
}

.message-input:focus {
    border-color: #667eea;
    background: var(--card, white);
    box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
}

.message-input::placeholder {
    color: var(--text-light, #9ca3af);
}

.send-button {
    padding: 14px 28px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 16px;
    cursor: pointer;
    font-weight: 800;
    font-size: 15px;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    display: inline-flex;
    align-items: center;
    gap: 8px;
}

.send-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
}

.send-button:active {
    transform: translateY(0);
}

.send-button svg {
    width: 18px;
    height: 18px;
}

.send-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none !important;
}

/* Empty Chat State */
.empty-chat {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    color: var(--text-light, #9ca3af);
    background: var(--background, #f9fafb);
}

.empty-chat-icon {
    font-size: 80px;
    margin-bottom: 24px;
    opacity: 0.2;
}

.empty-chat-icon i {
    font-size: 80px;
}

.empty-chat h3 {
    font-size: 24px;
    font-weight: 800;
    color: var(--text, #111827);
    margin-bottom: 8px;
}

.empty-chat p {
    font-size: 16px;
    color: var(--text-light, #6b7280);
    font-weight: 500;
}

/* Scrollbar Styling */
.conversations-list::-webkit-scrollbar,
.messages-area::-webkit-scrollbar {
    width: 8px;
}

.conversations-list::-webkit-scrollbar-track,
.messages-area::-webkit-scrollbar-track {
    background: transparent;
}

.conversations-list::-webkit-scrollbar-thumb,
.messages-area::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 10px;
}

.conversations-list::-webkit-scrollbar-thumb:hover,
.messages-area::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
}

/* Action Buttons */
.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.archive-toggle-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
}

/* Mobile Back Button */
.mobile-back-btn {
    display: none;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    background: var(--background, #f9fafb);
    border: 2px solid var(--border, #e5e7eb);
    color: var(--text, #111827);
    cursor: pointer;
    transition: all 0.2s ease;
    margin-right: 12px;
    flex-shrink: 0;
}

.mobile-back-btn:hover {
    background: var(--border, #e5e7eb);
    transform: translateX(-2px);
}

.mobile-back-btn i {
    font-size: 20px;
}

/* Responsive Design */
@media (max-width: 968px) {
    .messages-container {
        grid-template-columns: 1fr;
        position: relative;
        overflow: hidden;
    }
    
    .conversations-sidebar {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
        background: var(--card, white);
        display: block;
        transform: translateX(-100%);
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        will-change: transform;
    }
    
    .conversations-sidebar:not(.hidden) {
        transform: translateX(0);
        pointer-events: auto;
    }
    
    .conversations-sidebar.hidden {
        transform: translateX(-100%);
        pointer-events: none;
    }
    
    .chat-area {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 2;
        display: block;
        transform: translateX(100%);
        transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        will-change: transform;
    }
    
    .chat-area.hidden {
        transform: translateX(100%);
        pointer-events: none;
    }
    
    .chat-area:not(.hidden) {
        transform: translateX(0);
        pointer-events: auto;
    }
    
    .mobile-back-btn {
        display: flex;
    }
    
    .empty-chat {
        display: none !important;
    }
    
    .messages-page {
        padding: 16px 16px 12px 16px;
        height: calc(100vh - 80px);
        max-height: calc(100vh - 80px);
        top: 80px;
    }
    
    .messages-container {
        height: calc(100vh - 124px);
        min-height: 350px;
        max-height: calc(100vh - 124px);
    }
}

@media (max-width: 480px) {
    .messages-page {
        padding: 16px 16px 12px 16px;
        height: calc(100vh - 80px);
    }
    
    .messages-container {
        border-radius: 16px;
        height: calc(100vh - 124px);
        min-height: 300px;
        max-height: calc(100vh - 124px);
    }
    
    .chat-header {
        padding: 20px;
    }
    
    .messages-area {
        padding: 20px;
    }
    
    .message-input-area {
        padding: 16px;
    }
    
    .message-bubble {
        max-width: 95%;
    }
}

/* Dark Mode Styles for Messages */
[data-theme="dark"] .messages-page {
    background: var(--background) !important;
}

[data-theme="dark"] .messages-container {
    background: var(--card) !important;
    border-color: var(--border) !important;
}

[data-theme="dark"] .conversations-sidebar {
    background: var(--background) !important;
    border-right-color: var(--border) !important;
}

[data-theme="dark"] .conversations-header {
    background: var(--card) !important;
    border-bottom-color: var(--border) !important;
}

[data-theme="dark"] .conversation-item {
    background: var(--card) !important;
    border-color: transparent;
}

[data-theme="dark"] .conversation-item:hover:not(.swiping):not([style*="translateX"]) {
    border-color: var(--border) !important;
}

[data-theme="dark"] .conversation-item.active {
    background: var(--card) !important;
    border-color: #667eea !important;
}

[data-theme="dark"] .chat-area {
    background: var(--card) !important;
}

[data-theme="dark"] .chat-header {
    background: var(--card) !important;
    border-bottom-color: var(--border) !important;
}

[data-theme="dark"] .messages-area {
    background: var(--background) !important;
}

[data-theme="dark"] .message.received .message-bubble {
    background: var(--card) !important;
    border-color: var(--border) !important;
    color: var(--text) !important;
}

[data-theme="dark"] .message-input-area {
    background: var(--card) !important;
    border-top-color: var(--border) !important;
}

[data-theme="dark"] .message-input {
    background: var(--background) !important;
    border-color: var(--border) !important;
    color: var(--text) !important;
}

[data-theme="dark"] .message-input:focus {
    background: var(--card) !important;
}

[data-theme="dark"] .empty-chat {
    background: var(--background) !important;
    color: var(--text-light) !important;
}

[data-theme="dark"] .empty-chat h3 {
    color: var(--text) !important;
}

[data-theme="dark"] .empty-chat p {
    color: var(--text-light) !important;
}

[data-theme="dark"] .empty-state {
    color: var(--text-light) !important;
}

[data-theme="dark"] .empty-state p {
    color: var(--text-light) !important;
}

[data-theme="dark"] .conversations-list::-webkit-scrollbar-thumb,
[data-theme="dark"] .messages-area::-webkit-scrollbar-thumb {
    background: var(--border) !important;
}

[data-theme="dark"] .conversations-list::-webkit-scrollbar-thumb:hover,
[data-theme="dark"] .messages-area::-webkit-scrollbar-thumb:hover {
    background: var(--text-light) !important;
}

/* Override inline styles for dark mode */
[data-theme="dark"] .archive-toggle-btn {
    background: var(--background) !important;
    color: var(--brand) !important;
}

[data-theme="dark"] .archive-toggle-btn[style*="linear-gradient"] {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    color: white !important;
}

[data-theme="dark"] .action-btn[style*="background: #f3f4f6"] {
    background: var(--background) !important;
    color: var(--brand) !important;
}

[data-theme="dark"] .action-btn[style*="background: #fee2e2"] {
    background: rgba(239, 68, 68, 0.2) !important;
    color: #ef4444 !important;
}

[data-theme="dark"] #confirmationModalLabel {
    color: var(--text) !important;
}

[data-theme="dark"] #modalMessage {
    color: var(--text-light) !important;
}

[data-theme="dark"] .btn-secondary[style*="background: #f3f4f6"] {
    background: var(--background) !important;
    color: var(--text) !important;
}

[data-theme="dark"] .chat-user-username {
    color: var(--brand) !important;
}
</style>

<div class="messages-page">
    {% csrf_token %}
    <div class="messages-container">
        <!-- Conversations Sidebar -->
        <div class="conversations-sidebar">
            <div class="conversations-header">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2>Messages</h2>
                    <a href="?archived={% if view_archived %}false{% else %}true{% endif %}{% if selected_conversation %}&conversation={{ selected_conversation.id }}{% endif %}" 
                       class="archive-toggle-btn" 
                       style="padding: 8px 16px; background: {% if view_archived %}linear-gradient(135deg, #667eea 0%, #764ba2 100%){% else %}#f3f4f6{% endif %}; color: {% if view_archived %}white{% else %}#667eea{% endif %}; border-radius: 8px; text-decoration: none; font-size: 13px; font-weight: 700; transition: all 0.2s;">
                        {% if view_archived %}<i class="bi bi-inbox"></i> Active{% else %}<i class="bi bi-archive"></i> Archived{% endif %}
                    </a>
                </div>
            </div>
            <div class="conversations-list">
                {% if conversations %}
                    {% for conversation in conversations %}
                    <div class="conversation-swipe-wrapper" data-conversation-id="{{ conversation.id }}">
                        <a href="?conversation={{ conversation.id }}{% if view_archived %}&archived=true{% endif %}" 
                           class="conversation-item {% if selected_conversation.id == conversation.id %}active{% endif %}"
                           data-conversation-id="{{ conversation.id }}"
                           onclick="if (window.innerWidth <= 968) { event.preventDefault(); showChatView({{ conversation.id }}); return false; }">
                            <div class="conversation-user">
                                <div class="conversation-avatar">
                                    {% user_avatar conversation.other_user size='medium' %}
                                </div>
                                <div class="conversation-info">
                                    <div class="conversation-name">
                                        {{ conversation.other_user.first_name }} {{ conversation.other_user.last_name }}
                                    </div>
                                    {% if conversation.latest_message %}
                                    <div class="conversation-preview">
                                        {{ conversation.latest_message.content|truncatewords:5 }}
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="conversation-meta">
                                    {% if conversation.latest_message %}
                                    <div class="conversation-time">
                                        {{ conversation.latest_message.timestamp|date:"H:i" }}
                                    </div>
                                    {% endif %}
                                    {% if conversation.unread_count > 0 %}
                                    <span class="unread-badge">{{ conversation.unread_count }}</span>
                                    {% endif %}
                                </div>
                            </div>
                        </a>
                        <div class="conversation-actions">
                            {% if view_archived %}
                            <button class="conversation-action-btn unarchive-btn" 
                                    onclick="event.stopPropagation(); showUnarchiveModal({{ conversation.id }})"
                                    title="Unarchive">
                                <span><i class="bi bi-inbox"></i></span>
                                <span>Unarchive</span>
                            </button>
                            {% else %}
                            <button class="conversation-action-btn archive-btn" 
                                    onclick="event.stopPropagation(); showArchiveModal({{ conversation.id }})"
                                    title="Archive">
                                <span><i class="bi bi-archive"></i></span>
                                <span>Archive</span>
                            </button>
                            {% endif %}
                            <button class="conversation-action-btn delete-btn" 
                                    onclick="event.stopPropagation(); showDeleteModal({{ conversation.id }})"
                                    title="Delete">
                                <span><i class="bi bi-trash"></i></span>
                                <span>Delete</span>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="empty-state">
                        <div class="empty-state-icon"><i class="bi {% if view_archived %}bi-archive{% else %}bi-chat-dots{% endif %}"></i></div>
                        <p>{% if view_archived %}No archived conversations{% else %}No conversations yet{% endif %}</p>
                        <p style="font-size: 13px; margin-top: 8px; opacity: 0.7;">
                            {% if view_archived %}You haven't archived any conversations yet{% else %}Start messaging other users!{% endif %}
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Chat Area -->
        <div class="chat-area">
            {% if selected_conversation %}
                <!-- Chat Header -->
                <div class="chat-header">
                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <div class="chat-user-info" style="display: flex; align-items: center;">
                            <button class="mobile-back-btn" onclick="showConversationsList()" aria-label="Back to conversations">
                                <i class="bi bi-arrow-left"></i>
                            </button>
                            <div class="chat-avatar">
                                {% user_avatar other_user size='medium' %}
                            </div>
                            <div class="chat-user-details">
                                <div class="chat-user-name">
                                    {{ other_user.first_name }} {{ other_user.last_name }}
                                </div>
                                <div class="chat-user-username">
                                    @{{ other_user.username }}
                                </div>
                            </div>
                        </div>
                        <div class="chat-actions" style="display: flex; gap: 8px;">
                            {% if view_archived %}
                            <button onclick="showUnarchiveModal({{ selected_conversation.id }})" 
                                    class="action-btn unarchive-btn" 
                                    title="Unarchive conversation"
                                    style="padding: 10px 16px; background: #f3f4f6; border: none; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 700; color: #667eea; transition: all 0.2s;">
                                <i class="bi bi-inbox"></i> Unarchive
                            </button>
                            {% else %}
                            <button onclick="showArchiveModal({{ selected_conversation.id }})" 
                                    class="action-btn archive-btn" 
                                    title="Archive conversation"
                                    style="padding: 10px 16px; background: #f3f4f6; border: none; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 700; color: #667eea; transition: all 0.2s;">
                                <i class="bi bi-archive"></i> Archive
                            </button>
                            {% endif %}
                            <button onclick="showDeleteModal({{ selected_conversation.id }})" 
                                    class="action-btn delete-btn" 
                                    title="Delete conversation"
                                    style="padding: 10px 16px; background: #fee2e2; border: none; border-radius: 10px; cursor: pointer; font-size: 13px; font-weight: 700; color: #dc2626; transition: all 0.2s;">
                                <i class="bi bi-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="messages-area" id="messagesArea">
                    {% for message in messages %}
                    <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}" data-message-id="{{ message.id }}">
                        <div class="message-bubble">
                            <div class="message-content">{{ message.content }}</div>
                            <div class="message-time">{{ message.timestamp|date:"H:i" }}</div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="no-messages">
                        <div class="no-messages-icon"><i class="bi bi-chat-left-text"></i></div>
                        <p>No messages yet. Start the conversation!</p>
                    </div>
                    {% endfor %}
                </div>

                <!-- Message Input -->
                <div class="message-input-area">
                    <form method="post" action="{% url 'chat:send_message' selected_conversation.id %}" 
                          class="message-form" id="messageForm">
                        {% csrf_token %}
                        <input type="text" 
                               name="content" 
                               class="message-input" 
                               placeholder="Type your message..." 
                               required
                               autocomplete="off">
                        <button type="submit" class="send-button">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                            Send
                        </button>
                    </form>
                </div>
            {% else %}
                <!-- Empty State -->
                <div class="empty-chat">
                    <div class="empty-chat-icon"><i class="bi bi-chat-dots"></i></div>
                    <h3>Select a Conversation</h3>
                    <p>Choose a conversation from the sidebar to start messaging</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 16px; border: none; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);">
            <div class="modal-header" style="border-bottom: 2px solid #f3f4f6; padding: 24px 28px;">
                <h5 class="modal-title" id="confirmationModalLabel" style="font-weight: 800; font-size: 20px; color: #111827;">
                    <span id="modalIcon" style="font-size: 28px; margin-right: 12px;"></span>
                    <span id="modalTitle"></span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="padding: 28px;">
                <p id="modalMessage" style="font-size: 15px; color: #6b7280; font-weight: 500; line-height: 1.6; margin: 0;"></p>
            </div>
            <div class="modal-footer" style="border-top: 2px solid #f3f4f6; padding: 20px 28px; gap: 12px;">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="padding: 10px 24px; border-radius: 10px; font-weight: 700; border: none; background: #f3f4f6; color: #6b7280;">
                    Cancel
                </button>
                <button type="button" class="btn" id="confirmActionBtn" style="padding: 10px 24px; border-radius: 10px; font-weight: 700; border: none; color: white;">
                    Confirm
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const conversationId = {% if selected_conversation %}{{ selected_conversation.id }}{% else %}null{% endif %};
let lastMessageId = {{ last_message_id|default:"0" }};
let pollingInterval = null;
let isPolling = false;

// Auto-scroll to bottom of messages
const messagesArea = document.getElementById('messagesArea');
if (messagesArea && messagesArea.children.length > 0) {
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

// AJAX message sending
const messageForm = document.getElementById('messageForm');
if (messageForm) {
    messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const input = this.querySelector('input[name="content"]');
        const content = input.value.trim();
        
        if (!content || !conversationId) {
            return;
        }
        
        // Disable form while sending
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalHTML = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width:18px;height:18px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Sending...';
        
        // Send via AJAX
        fetch(`{% url 'chat:send_message' 0 %}`.replace('0', conversationId), {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `content=${encodeURIComponent(content)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Clear input
                input.value = '';
                
                // Add message to UI immediately
                addMessageToUI(data.message, true);
                
                // Update last message ID
                lastMessageId = data.message.id;
            } else {
                alert('Failed to send message. Please try again.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to send message. Please try again.');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalHTML;
        });
    });
}

// Add message to UI
function addMessageToUI(messageData, isSent) {
    const messagesArea = document.getElementById('messagesArea');
    if (!messagesArea) return;
    
    // Remove "no messages" placeholder if exists
    const noMessages = messagesArea.querySelector('.no-messages');
    if (noMessages) {
        noMessages.remove();
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isSent ? 'sent' : 'received'}`;
    messageDiv.dataset.messageId = messageData.id;
    
    messageDiv.innerHTML = `
        <div class="message-bubble">
            <div class="message-content">${escapeHtml(messageData.content)}</div>
            <div class="message-time">${messageData.timestamp}</div>
        </div>
    `;
    
    messagesArea.appendChild(messageDiv);
    
    // Scroll to bottom
    messagesArea.scrollTop = messagesArea.scrollHeight;
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Poll for new messages
function pollForNewMessages() {
    if (!conversationId || isPolling) return;
    
    isPolling = true;
    fetch(`{% url 'chat:get_new_messages' 0 %}?last_message_id=${lastMessageId}`.replace('0', conversationId))
        .then(response => response.json())
        .then(data => {
            if (data.success && data.messages.length > 0) {
                data.messages.forEach(msg => {
                    addMessageToUI(msg, msg.is_sent);
                    lastMessageId = Math.max(lastMessageId, msg.id);
                });
                
                // Update unread counts in sidebar
                updateConversationsList();
            }
        })
        .catch(error => {
            console.error('Polling error:', error);
        })
        .finally(() => {
            isPolling = false;
        });
}

// Update conversations list
function updateConversationsList() {
    fetch('{% url "chat:get_conversations_update" %}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update unread badges in sidebar
                data.conversations.forEach(conv => {
                    const convItem = document.querySelector(`.conversation-item[href*="conversation=${conv.id}"]`);
                    if (convItem) {
                        const badge = convItem.querySelector('.unread-badge');
                        if (conv.unread_count > 0) {
                            if (!badge) {
                                const meta = convItem.querySelector('.conversation-meta');
                                const badgeEl = document.createElement('span');
                                badgeEl.className = 'unread-badge';
                                badgeEl.textContent = conv.unread_count;
                                meta.appendChild(badgeEl);
                            } else {
                                badge.textContent = conv.unread_count;
                            }
                        } else if (badge) {
                            badge.remove();
                        }
                    }
                });
            }
        })
        .catch(error => {
            console.error('Update conversations error:', error);
        });
}

// Start polling when conversation is selected
if (conversationId) {
    // Poll every 3 seconds
    pollingInterval = setInterval(pollForNewMessages, 3000);
    
    // Also poll immediately
    setTimeout(pollForNewMessages, 1000);
    
    // Update conversations list every 5 seconds
    setInterval(updateConversationsList, 5000);
}

// Clean up on page unload
window.addEventListener('beforeunload', function() {
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
});

// Modal functions
let pendingConversationId = null;
let pendingAction = null;

function showArchiveModal(conversationId) {
    pendingConversationId = conversationId;
    pendingAction = 'archive';
    
    document.getElementById('modalIcon').innerHTML = '<i class="bi bi-archive" style="color: #667eea;"></i>';
    document.getElementById('modalTitle').textContent = 'Archive Conversation';
    document.getElementById('modalMessage').textContent = 'Are you sure you want to archive this conversation? You can view it later in the archived section.';
    document.getElementById('confirmActionBtn').textContent = 'Archive';
    document.getElementById('confirmActionBtn').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    
    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    modal.show();
}

function showUnarchiveModal(conversationId) {
    pendingConversationId = conversationId;
    pendingAction = 'unarchive';
    
    document.getElementById('modalIcon').innerHTML = '<i class="bi bi-inbox" style="color: #10b981;"></i>';
    document.getElementById('modalTitle').textContent = 'Unarchive Conversation';
    document.getElementById('modalMessage').textContent = 'Are you sure you want to unarchive this conversation? It will be moved back to your active conversations.';
    document.getElementById('confirmActionBtn').textContent = 'Unarchive';
    document.getElementById('confirmActionBtn').style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
    
    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    modal.show();
}

function showDeleteModal(conversationId) {
    pendingConversationId = conversationId;
    pendingAction = 'delete';
    
    document.getElementById('modalIcon').innerHTML = '<i class="bi bi-trash" style="color: #ef4444;"></i>';
    document.getElementById('modalTitle').textContent = 'Delete Conversation';
    document.getElementById('modalMessage').textContent = 'Are you sure you want to delete this conversation? This action cannot be undone and all messages will be permanently removed.';
    document.getElementById('confirmActionBtn').textContent = 'Delete';
    document.getElementById('confirmActionBtn').style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
    
    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    modal.show();
}

// Handle modal confirmation
const confirmBtn = document.getElementById('confirmActionBtn');
let confirmHandler = null;

function setupConfirmHandler() {
    if (confirmHandler) {
        confirmBtn.removeEventListener('click', confirmHandler);
    }
    
    confirmHandler = function() {
        if (!pendingConversationId || !pendingAction) return;
        
        const conversationId = pendingConversationId;
        const action = pendingAction;
        
        // Close modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
        modal.hide();
        
        // Execute action
        if (action === 'archive') {
            archiveConversation(conversationId);
        } else if (action === 'unarchive') {
            unarchiveConversation(conversationId);
        } else if (action === 'delete') {
            deleteConversation(conversationId);
        }
        
        // Reset
        pendingConversationId = null;
        pendingAction = null;
    };
    
    confirmBtn.addEventListener('click', confirmHandler);
}

// Initialize on page load
setupConfirmHandler();

// Mobile view management
function isMobileView() {
    return window.innerWidth <= 968;
}

function showConversationsList() {
    if (!isMobileView()) return;
    
    const sidebar = document.querySelector('.conversations-sidebar');
    const chatArea = document.querySelector('.chat-area');
    
    // First, slide chat out to the right
    if (chatArea) {
        chatArea.classList.add('hidden');
        // Force reflow to ensure transition starts immediately
        void chatArea.offsetHeight;
    }
    
    // Wait for chat to partially slide out, then slide sidebar in from the left
    // This creates a smooth sequential animation where chat exits first
    setTimeout(() => {
        if (sidebar) {
            sidebar.classList.remove('hidden');
            // Force reflow to ensure transition starts
            void sidebar.offsetHeight;
        }
    }, 120); // Delay to let chat start sliding out first (about 30% of animation)
    
    // Update URL without conversation parameter
    const url = new URL(window.location);
    url.searchParams.delete('conversation');
    window.history.pushState({}, '', url);
}

function showChatView(conversationId) {
    if (!isMobileView()) {
        // Desktop: normal navigation
        window.location.href = `?conversation=${conversationId}{% if view_archived %}&archived=true{% endif %}`;
        return;
    }
    
    const sidebar = document.querySelector('.conversations-sidebar');
    const chatArea = document.querySelector('.chat-area');
    
    // Hide sidebar first, then show chat area with animation
    if (sidebar) {
        sidebar.classList.add('hidden');
    }
    
    // Small delay to allow sidebar to start sliding out
    setTimeout(() => {
        if (chatArea) {
            chatArea.classList.remove('hidden');
            // Force reflow to ensure transition
            chatArea.offsetHeight;
        }
    }, 50);
    
    // Update URL with conversation parameter and reload to get conversation data
    const url = new URL(window.location);
    url.searchParams.set('conversation', conversationId);
    window.location.href = url.toString();
}

// Handle initial state on mobile
if (isMobileView()) {
    const hasConversation = {% if selected_conversation %}true{% else %}false{% endif %};
    
    const sidebar = document.querySelector('.conversations-sidebar');
    const chatArea = document.querySelector('.chat-area');
    
    // Set initial state without animation on page load
    if (hasConversation) {
        // Show chat view, hide sidebar
        if (sidebar) {
            sidebar.classList.add('hidden');
            sidebar.style.transition = 'none'; // No animation on initial load
        }
        if (chatArea) {
            chatArea.classList.remove('hidden');
            chatArea.style.transition = 'none'; // No animation on initial load
        }
        // Re-enable transitions after initial state is set
        setTimeout(() => {
            if (sidebar) sidebar.style.transition = '';
            if (chatArea) chatArea.style.transition = '';
        }, 50);
    } else {
        // Show sidebar, hide chat area
        if (sidebar) {
            sidebar.classList.remove('hidden');
            sidebar.style.transition = 'none'; // No animation on initial load
        }
        if (chatArea) {
            chatArea.classList.add('hidden');
            chatArea.style.transition = 'none'; // No animation on initial load
        }
        // Re-enable transitions after initial state is set
        setTimeout(() => {
            if (sidebar) sidebar.style.transition = '';
            if (chatArea) chatArea.style.transition = '';
        }, 50);
    }
}

// Handle window resize
let resizeTimer;
window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
        if (!isMobileView()) {
            // Desktop: show both
            const sidebar = document.querySelector('.conversations-sidebar');
            const chatArea = document.querySelector('.chat-area');
            if (sidebar) {
                sidebar.classList.remove('hidden');
                sidebar.style.position = '';
                sidebar.style.display = '';
            }
            if (chatArea) {
                chatArea.classList.remove('hidden');
                chatArea.style.position = '';
                chatArea.style.display = '';
            }
        } else {
            // Mobile: apply mobile logic
            const hasConversation = {% if selected_conversation %}true{% else %}false{% endif %};
            const sidebar = document.querySelector('.conversations-sidebar');
            const chatArea = document.querySelector('.chat-area');
            if (hasConversation) {
                if (sidebar) {
                    sidebar.classList.add('hidden');
                }
                if (chatArea) {
                    chatArea.classList.remove('hidden');
                    chatArea.offsetHeight; // Force reflow
                }
            } else {
                if (sidebar) {
                    sidebar.classList.remove('hidden');
                    sidebar.offsetHeight; // Force reflow
                }
                if (chatArea) {
                    chatArea.classList.add('hidden');
                }
            }
        }
    }, 250);
});

// Archive conversation
function archiveConversation(conversationId) {
    fetch(`{% url 'chat:archive_conversation' 0 %}`.replace('0', conversationId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '{% url "chat:messages" %}';
        } else {
            showErrorModal('Failed to archive conversation. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorModal('Failed to archive conversation. Please try again.');
    });
}

// Unarchive conversation
function unarchiveConversation(conversationId) {
    fetch(`{% url 'chat:unarchive_conversation' 0 %}`.replace('0', conversationId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '{% url "chat:messages" %}';
        } else {
            showErrorModal('Failed to unarchive conversation. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorModal('Failed to unarchive conversation. Please try again.');
    });
}

// Delete conversation
function deleteConversation(conversationId) {
    fetch(`{% url 'chat:delete_conversation' 0 %}`.replace('0', conversationId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.href = '{% url "chat:messages" %}';
        } else {
            showErrorModal('Failed to delete conversation. Please try again.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showErrorModal('Failed to delete conversation. Please try again.');
    });
}

// Show error modal (reuse confirmation modal)
function showErrorModal(message) {
    // Remove existing handler temporarily
    if (confirmHandler) {
        confirmBtn.removeEventListener('click', confirmHandler);
    }
    
    document.getElementById('modalIcon').innerHTML = '<i class="bi bi-exclamation-triangle" style="color: #ef4444;"></i>';
    document.getElementById('modalTitle').textContent = 'Error';
    document.getElementById('modalMessage').textContent = message;
    confirmBtn.textContent = 'OK';
    confirmBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    
    const errorHandler = function() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmationModal'));
        modal.hide();
        confirmBtn.removeEventListener('click', errorHandler);
        // Restore normal handler
        setupConfirmHandler();
    };
    
    confirmBtn.addEventListener('click', errorHandler);
    
    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    modal.show();
}

// Swipe functionality for conversation items
(function() {
    const SWIPE_THRESHOLD = 30; // Minimum swipe distance to keep swiped
    const MAX_SWIPE = 170; // Maximum swipe distance (85px * 2 buttons)
    
    function initSwipe() {
        const conversationItems = document.querySelectorAll('.conversation-item');
        
        conversationItems.forEach(item => {
            let swipeStartX = 0;
            let swipeCurrentX = 0;
            let isSwipeActive = false;
            let hasSwiped = false;
            let startTime = 0;
            let justSwiped = false; // Flag to prevent click handler from interfering

            // Mouse events
            item.addEventListener('mousedown', (e) => {
                // Don't start swipe if clicking on action buttons
                if (e.target.closest('.conversation-actions')) {
                    return;
                }
                swipeStartX = e.clientX;
                startTime = Date.now();
                isSwipeActive = true;
                justSwiped = false;
                item.classList.add('swiping');
                e.preventDefault();
                e.stopPropagation();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isSwipeActive || !item.classList.contains('swiping')) return;
                
                swipeCurrentX = e.clientX - swipeStartX;
                
                // Only allow swiping left (negative values)
                if (swipeCurrentX > 0) {
                    swipeCurrentX = 0;
                } else if (Math.abs(swipeCurrentX) > MAX_SWIPE) {
                    swipeCurrentX = -MAX_SWIPE;
                }
                
                item.style.transform = `translateX(${swipeCurrentX}px)`;
                hasSwiped = Math.abs(swipeCurrentX) > 10;
            });

            document.addEventListener('mouseup', (e) => {
                if (!isSwipeActive) return;
                
                const swipeTime = Date.now() - startTime;
                const currentSwipeX = swipeCurrentX; // Save current value before resetting
                const wasDragging = hasSwiped || Math.abs(swipeCurrentX) > 10;
                
                isSwipeActive = false;
                item.classList.remove('swiping');
                
                // If user dragged left (swiped), keep it at the current position
                if (wasDragging && currentSwipeX < 0) {
                    // Keep it swiped at current position (or max if beyond)
                    const finalX = Math.abs(currentSwipeX) > MAX_SWIPE ? -MAX_SWIPE : currentSwipeX;
                    // Re-enable transition for smooth snap
                    item.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                    item.style.transform = `translateX(${finalX}px)`;
                    justSwiped = true;
                    
                    // Close other swiped items
                    conversationItems.forEach(otherItem => {
                        if (otherItem !== item && otherItem.style.transform && otherItem.style.transform.includes('translateX')) {
                            otherItem.style.transform = '';
                        }
                    });
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Reset flag after a short delay to allow click handler to work later
                    setTimeout(() => {
                        justSwiped = false;
                    }, 100);
                } else if (!wasDragging && swipeTime < 200 && Math.abs(currentSwipeX) < 10) {
                    // Quick click (no drag), allow navigation
                    justSwiped = false;
                    const href = item.getAttribute('href');
                    if (href) {
                        window.location.href = href;
                    }
                } else {
                    // Snap back if no meaningful drag
                    justSwiped = false;
                    item.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                    item.style.transform = '';
                }
                
                swipeCurrentX = 0;
                hasSwiped = false;
            });

            // Touch events
            item.addEventListener('touchstart', (e) => {
                // Don't start swipe if clicking on action buttons
                if (e.target.closest('.conversation-actions')) {
                    return;
                }
                swipeStartX = e.touches[0].clientX;
                startTime = Date.now();
                isSwipeActive = true;
                item.classList.add('swiping');
            }, { passive: true });

            item.addEventListener('touchmove', (e) => {
                if (!isSwipeActive) return;
                
                swipeCurrentX = e.touches[0].clientX - swipeStartX;
                
                // Only allow swiping left
                if (swipeCurrentX > 0) {
                    swipeCurrentX = 0;
                } else if (Math.abs(swipeCurrentX) > MAX_SWIPE) {
                    swipeCurrentX = -MAX_SWIPE;
                }
                
                item.style.transform = `translateX(${swipeCurrentX}px)`;
                hasSwiped = Math.abs(swipeCurrentX) > 10;
                
                // Prevent scrolling if swiping
                if (hasSwiped) {
                    e.preventDefault();
                }
            }, { passive: false });

            item.addEventListener('touchend', (e) => {
                if (!isSwipeActive) return;
                
                const swipeTime = Date.now() - startTime;
                const currentSwipeX = swipeCurrentX; // Save current value before resetting
                const wasDragging = hasSwiped || Math.abs(swipeCurrentX) > 10;
                
                isSwipeActive = false;
                item.classList.remove('swiping');
                
                // If user dragged left (swiped), keep it at the current position
                if (wasDragging && currentSwipeX < 0) {
                    // Keep it swiped at current position (or max if beyond)
                    const finalX = Math.abs(currentSwipeX) > MAX_SWIPE ? -MAX_SWIPE : currentSwipeX;
                    // Re-enable transition for smooth snap
                    item.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                    item.style.transform = `translateX(${finalX}px)`;
                    // Close other swiped items
                    conversationItems.forEach(otherItem => {
                        if (otherItem !== item && otherItem.style.transform && otherItem.style.transform.includes('translateX')) {
                            otherItem.style.transform = '';
                        }
                    });
                    e.preventDefault();
                } else if (!wasDragging && swipeTime < 200 && Math.abs(currentSwipeX) < 10) {
                    // Quick tap (no drag), allow navigation
                    const href = item.getAttribute('href');
                    if (href) {
                        window.location.href = href;
                    }
                } else {
                    // Snap back if no meaningful drag
                    item.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                    item.style.transform = '';
                }
                
                swipeCurrentX = 0;
                hasSwiped = false;
            }, { passive: false });

            // Click handler - close swipe if clicked on item (not buttons)
            item.addEventListener('click', (e) => {
                // Don't interfere with hamburger menu or other important buttons
                if (e.target.closest('.toggle-sidebar-btn') || 
                    e.target.closest('#sidebarToggle') ||
                    e.target.closest('.mobile-back-btn') ||
                    e.target.closest('#sidebar') ||
                    e.target.closest('.overlay')) {
                    return;
                }
                
                // Don't interfere if we just swiped
                if (justSwiped) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
                
                // If buttons are visible (swiped), close on click (unless clicking buttons)
                const transform = item.style.transform;
                if (transform && transform.includes('translateX')) {
                    const match = transform.match(/-?\d+/);
                    if (match && Math.abs(parseInt(match[0])) >= SWIPE_THRESHOLD) {
                        // Don't close if clicking on action buttons
                        if (!e.target.closest('.conversation-actions')) {
                            e.preventDefault();
                            e.stopPropagation();
                            item.style.transform = '';
                            return false;
                        }
                    }
                }
            }, true);
        });

        // Close swiped items when clicking elsewhere
        document.addEventListener('click', (e) => {
            // Don't interfere with hamburger menu or other important buttons
            if (e.target.closest('.toggle-sidebar-btn') || 
                e.target.closest('#sidebarToggle') ||
                e.target.closest('.mobile-back-btn') ||
                e.target.closest('#sidebar') ||
                e.target.closest('.overlay')) {
                return;
            }
            
            if (!e.target.closest('.conversation-swipe-wrapper')) {
                conversationItems.forEach(item => {
                    if (item.style.transform && item.style.transform.includes('translateX')) {
                        item.style.transform = '';
                    }
                });
            }
        });
    }
    
    // Initialize on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initSwipe);
    } else {
        initSwipe();
    }
})();

// Ensure hamburger menu button is always accessible
// Re-initialize if base template's script didn't run
(function() {
    function ensureHamburgerWorks() {
        const toggleBtn = document.getElementById('sidebarToggle');
        if (toggleBtn && !toggleBtn.hasAttribute('data-listener-added')) {
            // Check if base template's listener is already there
            const hasListener = toggleBtn.onclick !== null || 
                               toggleBtn.getAttribute('onclick') !== null;
            
            if (!hasListener) {
                // Re-add the toggle functionality
                toggleBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const sidebar = document.getElementById('sidebar');
                    const overlay = document.getElementById('overlay');
                    
                    if (sidebar && window.innerWidth <= 1200) {
                        const isOpen = sidebar.classList.contains('open');
                        if (isOpen) {
                            sidebar.classList.remove('open');
                            if (overlay) overlay.classList.remove('active');
                            document.body.style.overflow = '';
                        } else {
                            sidebar.classList.add('open');
                            if (overlay) overlay.classList.add('active');
                            document.body.style.overflow = 'hidden';
                        }
                    }
                });
                toggleBtn.setAttribute('data-listener-added', 'true');
            }
        }
    }
    
    // Try immediately and after DOM is ready
    ensureHamburgerWorks();
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', ensureHamburgerWorks);
    }
    // Also try after a short delay to ensure base template's script has run
    setTimeout(ensureHamburgerWorks, 100);
})();

// Prevent page scrolling - make messages page static
(function() {
    function preventPageScroll() {
        // Prevent body from scrolling
        document.body.style.overflow = 'hidden';
        document.body.style.height = '100vh';
        document.body.style.position = 'fixed';
        document.body.style.width = '100%';
        
        // Also prevent html from scrolling
        document.documentElement.style.overflow = 'hidden';
        document.documentElement.style.height = '100vh';
        
        // Prevent page-body wrapper from scrolling
        const pageBody = document.querySelector('.page-body');
        if (pageBody) {
            pageBody.style.overflow = 'hidden';
            pageBody.style.height = '100vh';
        }
    }
    
    // Apply immediately
    preventPageScroll();
    
    // Also apply on load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', preventPageScroll);
    } else {
        preventPageScroll();
    }
    
    // Clean up on page unload (when navigating away)
    window.addEventListener('beforeunload', function() {
        document.body.style.overflow = '';
        document.body.style.height = '';
        document.body.style.position = '';
        document.body.style.width = '';
        document.documentElement.style.overflow = '';
        document.documentElement.style.height = '';
        const pageBody = document.querySelector('.page-body');
        if (pageBody) {
            pageBody.style.overflow = '';
            pageBody.style.height = '';
        }
    });
})();
</script>
{% endblock %}