{% extends 'base.html' %}
{% load static %}

{% block title %}Admin - User Classes Management{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h2 class="mb-4 d-flex align-items-center gap-2">
                <i class="fas fa-chalkboard-teacher"></i>
                Admin - User Classes Management
            </h2>

            <!-- Search and Filter Form -->
            <div class="card mb-4">
                <div class="card-body">
                    <form method="GET" class="row g-3 align-items-end">
                        <div class="col-md-4">
                            <label for="search" class="form-label">Search Teachers</label>
                            <input type="text"
                                   class="form-control"
                                   id="search"
                                   name="search"
                                   value="{{ search_query }}"
                                   placeholder="Enter username...">
                        </div>
                        <div class="col-md-4">
                            <label for="class" class="form-label">Filter by Class Title</label>
                            <input type="text"
                                   class="form-control"
                                   id="class"
                                   name="class"
                                   value="{{ class_filter }}"
                                   placeholder="Enter class title...">
                        </div>
                        <div class="col-md-3">
                            <label for="status" class="form-label">Publication Status</label>
                            <select id="status" name="status" class="form-select">
                                <option value="">All Classes</option>
                                <option value="published" {% if status_filter == 'published' %}selected{% endif %}>Published</option>
                                <option value="unpublished" {% if status_filter == 'unpublished' %}selected{% endif %}>Unpublished</option>
                            </select>
                        </div>
                        <div class="col-md-1 d-grid">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i>
                                Search
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Summary -->
            <div class="alert alert-info d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div>
                    <strong>Total Classes:</strong> {{ total_classes }}
                </div>
                <div>
                    <strong>Teachers Displayed:</strong> {{ teacher_data|length }}
                </div>
            </div>

            <!-- Teachers and Classes List -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list"></i>
                        Teachers and Their Classes
                    </h5>
                    {% if teacher_data %}
                        <span class="badge bg-secondary">
                            {{ total_classes }} class{{ total_classes|pluralize }}
                        </span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if teacher_data %}
                        {% for data in teacher_data %}
                            <div class="teacher-section pb-4 mb-4 border-bottom">
                                <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
                                    <div class="d-flex align-items-center gap-3">
                                        {% if data.teacher.profile.avatar %}
                                            <img src="{{ data.teacher.profile.avatar.url }}"
                                                 alt="{{ data.teacher.username }}"
                                                 class="rounded-circle"
                                                 style="width: 48px; height: 48px; object-fit: cover;">
                                        {% else %}
                                            <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                                                 style="width: 48px; height: 48px;">
                                                <i class="fas fa-user"></i>
                                            </div>
                                        {% endif %}
                                        <div>
                                            <h5 class="mb-0">{{ data.teacher.username }}</h5>
                                            <small class="text-muted">
                                                {{ data.teacher.get_full_name|default:data.teacher.email }}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="d-flex flex-wrap gap-2">
                                        <span class="badge bg-success">
                                            <i class="fas fa-check-circle"></i>
                                            {{ data.published_count }} published
                                        </span>
                                        <span class="badge bg-warning text-dark">
                                            <i class="fas fa-clock"></i>
                                            {{ data.unpublished_count }} unpublished
                                        </span>
                                    </div>
                                </div>

                                <div class="row g-3 mt-3">
                                    {% for cls in data.classes %}
                                        <div class="col-12">
                                            <div class="class-card card shadow-sm" data-class-id="{{ cls.id }}">
                                                <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                                                    <div class="flex-grow-1">
                                                        <div class="d-flex align-items-center gap-2 flex-wrap">
                                                            <h5 class="card-title mb-0">{{ cls.title }}</h5>
                                                            <span class="badge {% if cls.is_published %}bg-success{% else %}bg-secondary{% endif %}">
                                                                {% if cls.is_published %}
                                                                    <i class="fas fa-broadcast-tower"></i> Published
                                                                {% else %}
                                                                    <i class="fas fa-eye-slash"></i> Unpublished
                                                                {% endif %}
                                                            </span>
                                                            {% if cls.is_tradeable %}
                                                                <span class="badge bg-info text-dark">
                                                                    <i class="fas fa-exchange-alt"></i> Tradeable
                                                                </span>
                                                            {% endif %}
                                                        </div>
                                                        <div class="text-muted small mt-2">
                                                            <span class="me-3">
                                                                <i class="fas fa-layer-group"></i>
                                                                {{ cls.get_difficulty_display }}
                                                            </span>
                                                            <span class="me-3">
                                                                <i class="fas fa-clock"></i>
                                                                {{ cls.duration_minutes }} min
                                                            </span>
                                                            <span class="me-3">
                                                                <i class="fas fa-dollar-sign"></i>
                                                                {{ cls.admin_price_display }}
                                                            </span>
                                                            <span class="me-3">
                                                                <i class="fas fa-calendar-alt"></i>
                                                                {{ cls.created_at|date:"M j, Y" }}
                                                            </span>
                                                            <span>
                                                                <i class="fas fa-hashtag"></i>
                                                                {{ cls.slug }}
                                                            </span>
                                                        </div>
                                                        {% if cls.short_description %}
                                                            <p class="mb-0 mt-2 text-muted">
                                                                {{ cls.short_description|truncatewords:25 }}
                                                            </p>
                                                        {% endif %}
                                                    </div>
                                                    <div class="d-flex flex-column flex-md-row align-items-md-center gap-2">
                                                        <a href="{% url 'skills:class_detail' cls.slug %}"
                                                           target="_blank"
                                                           class="btn btn-outline-primary btn-sm">
                                                            <i class="fas fa-external-link-alt"></i>
                                                            View
                                                        </a>
                                                        <button type="button"
                                                                class="btn btn-outline-danger btn-sm"
                                                                onclick="return queueDeleteClass('{{ cls.title|escapejs }}', '{{ data.teacher.username|escapejs }}', '{% url 'users:admin_delete_class' cls.id %}', this.closest('.class-card'));">
                                                            <i class="fas fa-trash"></i>
                                                            Delete
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    {% empty %}
                                        <div class="col-12">
                                            <div class="alert alert-light border text-center mb-0">
                                                <i class="fas fa-info-circle"></i>
                                                No classes found for this teacher.
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No classes found</h5>
                            <p class="text-muted mb-0">
                                {% if search_query or class_filter or status_filter %}
                                    Try adjusting your search filters.
                                {% else %}
                                    No classes have been created yet.
                                {% endif %}
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Navigation Links -->
            <div class="mt-4">
                <a href="{% url 'users:admin_user_skills' %}" class="btn btn-outline-danger">
                    <i class="fas fa-tools"></i> Manage User Skills
                </a>
                <a href="{% url 'skill_admin:skill_review' %}" class="btn btn-warning ms-2">
                    <i class="fas fa-clipboard-check"></i> Skill Review
                </a>
                <a href="{% url 'users:admin_user_verifications' %}" class="btn btn-secondary ms-2">
                    <i class="fas fa-id-card"></i> User Verifications
                </a>
                <a href="{% url 'communities:admin_community_requests' %}" class="btn btn-primary ms-2">
                    <i class="fas fa-users"></i> Community Requests
                </a>
                <a href="/admin/" class="btn btn-outline-secondary ms-2">
                    <i class="fas fa-cog"></i> Django Admin
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteClassModal" tabindex="-1" aria-labelledby="deleteClassModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteClassModalLabel">
                    <i class="fas fa-exclamation-triangle"></i>
                    Delete Class
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-trash-alt fa-3x text-danger"></i>
                </div>
                <p class="text-center mb-0">
                    Are you sure you want to delete the class
                    <strong id="classTitleToDelete"></strong>
                    taught by
                    <strong id="teacherNameToDelete"></strong>?
                </p>
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Warning:</strong> This will also remove associated enrollments, topics, reviews, and media. This action cannot be undone.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i>
                    Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteClassBtn">
                    <i class="fas fa-trash"></i>
                    Delete Class
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.class-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.class-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 18px rgba(15, 23, 42, 0.12);
}
</style>

<script>
let currentDeleteClassUrl = '';
let currentClassCard = null;

function queueDeleteClass(classTitle, teacherName, deleteUrl, classCardElement) {
    currentDeleteClassUrl = deleteUrl;
    currentClassCard = classCardElement;

    document.getElementById('classTitleToDelete').textContent = classTitle;
    document.getElementById('teacherNameToDelete').textContent = teacherName;

    const modal = new bootstrap.Modal(document.getElementById('deleteClassModal'));
    modal.show();

    return false;
}

document.getElementById('confirmDeleteClassBtn').addEventListener('click', function() {
    if (!currentDeleteClassUrl || !currentClassCard) {
        return;
    }

    this.disabled = true;
    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Deleting...';

    fetch(currentDeleteClassUrl, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            currentClassCard.remove();
            showToast(data.message, 'success');
            checkTeacherClasses(currentClassCard);
        } else {
            showToast(data.message || 'Failed to delete class.', 'error');
        }
    })
    .catch(error => {
        console.error('Error deleting class:', error);
        showToast('An error occurred while deleting the class.', 'error');
    })
    .finally(() => {
        this.disabled = false;
        this.innerHTML = '<i class="fas fa-trash"></i> Delete Class';

        const modalInstance = bootstrap.Modal.getInstance(document.getElementById('deleteClassModal'));
        if (modalInstance) {
            modalInstance.hide();
        }

        currentDeleteClassUrl = '';
        currentClassCard = null;
    });
});

document.getElementById('deleteClassModal').addEventListener('hidden.bs.modal', function() {
    currentDeleteClassUrl = '';
    currentClassCard = null;
});

function showToast(message, type) {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;

    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }

    toastContainer.insertAdjacentHTML('beforeend', toastHtml);

    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();

    toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

function checkTeacherClasses(deletedCard) {
    if (!deletedCard) {
        return;
    }

    const teacherSection = deletedCard.closest('.teacher-section');
    if (!teacherSection) {
        return;
    }

    const remainingClassCards = teacherSection.querySelectorAll('.class-card');
    if (remainingClassCards.length === 0) {
        teacherSection.style.opacity = '0.5';
        teacherSection.style.pointerEvents = 'none';
    }
}
</script>
{% endblock %}

