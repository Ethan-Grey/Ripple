{% extends 'base.html' %}
{% load static %}

{% block title %}Admin - User Verifications{% endblock %}

{% block content %}
<style>
.container.mt-4 {
    min-height: calc(100vh - 120px);
    padding-bottom: 100px;
}
</style>
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>
                    <i class="fas fa-users-cog"></i> User Identity Verifications
                </h2>
                <div class="d-flex gap-2">
                    <a href="{% url 'users:admin_user_skills' %}" class="btn btn-outline-danger">
                        <i class="fas fa-tools"></i> User Skills
                    </a>
                    <a href="/admin/" class="btn btn-outline-secondary">
                        <i class="fas fa-cog"></i> Django Admin
                    </a>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="search-input" class="form-label">Search Users</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                                <input type="text" class="form-control" id="search-input" placeholder="Enter username, first name, or last name...">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <label for="status-filter" class="form-label">Filter by Status</label>
                            <form method="GET" class="d-flex gap-2">
                                <select name="status" id="status-filter" class="form-select" onchange="this.form.submit()">
                                    <option value="all" {% if status == 'all' %}selected{% endif %}>All Statuses</option>
                                    <option value="pending" {% if status == 'pending' %}selected{% endif %}>Pending</option>
                                    <option value="verified" {% if status == 'verified' %}selected{% endif %}>Verified</option>
                                    <option value="unverified" {% if status == 'unverified' %}selected{% endif %}>Unverified</option>
                                </select>
                            </form>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="text-muted">
                                {% if rows %}
                                    <span class="badge bg-secondary">{{ rows|length }} user{{ rows|length|pluralize }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Verification Cards -->
            {% if rows %}
                {% for row in rows %}
                <div class="card mb-4 search-card" data-keywords="{{ row.profile.user.username }} {{ row.profile.user.first_name }} {{ row.profile.user.last_name }}">
                    <!-- User Header -->
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-3">
                                    {% if row.profile.avatar %}
                                        <img src="{{ row.profile.avatar.url }}" alt="{{ row.profile.user.username }}" class="rounded-circle" style="width: 50px; height: 50px; object-fit: cover;">
                                    {% else %}
                                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                            <span class="text-white fw-bold">{{ row.profile.user.username|first|upper }}</span>
                                        </div>
                                    {% endif %}
                                </div>
                                <div>
                                    <h6 class="mb-1">@{{ row.profile.user.username }}</h6>
                                    <p class="text-muted mb-0">
                                        {% if row.profile.user.first_name and row.profile.user.last_name %}
                                            {{ row.profile.user.first_name }} {{ row.profile.user.last_name }}
                                        {% else %}
                                            No name provided
                                        {% endif %}
                                    </p>
                                    <small class="text-muted">
                                        Submitted: {% if row.submission %}{{ row.submission.created_at|date:"F j, Y g:i A" }}{% else %}No submission{% endif %}
                                    </small>
                                </div>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="button" 
                                        class="btn btn-success btn-sm verification-action-btn"
                                        data-profile-id="{{ row.profile.id }}"
                                        data-action="approve"
                                        data-username="{{ row.profile.user.username }}">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button type="button" 
                                        class="btn btn-danger btn-sm verification-action-btn"
                                        data-profile-id="{{ row.profile.id }}"
                                        data-action="reject"
                                        data-username="{{ row.profile.user.username }}">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="card-body">
                        <div class="row">
                            <!-- Submitted Information -->
                            <div class="col-md-6">
                                <h6 class="mb-3">
                                    <i class="fas fa-info-circle text-primary"></i> Submitted Information
                                </h6>
                                {% if row.submission %}
                                    <div class="info-grid">
                                        <div class="row g-2">
                                            {% if row.submission.first_name and row.submission.last_name %}
                                            <div class="col-12">
                                                <div class="info-item">
                                                    <strong>Full Name:</strong>
                                                    <span>{{ row.submission.first_name }} {{ row.submission.last_name }}</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            <div class="col-md-6">
                                                {% if row.submission.dob %}
                                                <div class="info-item">
                                                    <strong>Date of Birth:</strong>
                                                    <span>{{ row.submission.dob|date:"F j, Y" }}</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="col-md-6">
                                                {% if row.submission.nationality %}
                                                <div class="info-item">
                                                    <strong>Nationality:</strong>
                                                    <span>{{ row.submission.nationality }}</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            {% if row.submission.address1 %}
                                            <div class="col-12">
                                                <div class="info-item">
                                                    <strong>Address:</strong>
                                                    <span>{{ row.submission.address1 }}{% if row.submission.address2 %}, {{ row.submission.address2 }}{% endif %}</span>
                                                </div>
                                            </div>
                                            {% endif %}
                                            
                                            <div class="col-md-4">
                                                {% if row.submission.state %}
                                                <div class="info-item">
                                                    <strong>State/Region:</strong>
                                                    <span>{{ row.submission.state }}</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="col-md-4">
                                                {% if row.submission.postal %}
                                                <div class="info-item">
                                                    <strong>Postal Code:</strong>
                                                    <span>{{ row.submission.postal }}</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                            
                                            <div class="col-md-4">
                                                {% if row.submission.country %}
                                                <div class="info-item">
                                                    <strong>Country:</strong>
                                                    <span>{{ row.submission.country }}</span>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i> No submission details available
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Submitted Documents -->
                            <div class="col-md-6">
                                <h6 class="mb-3">
                                    <i class="fas fa-file-alt text-success"></i> Submitted Documents
                                </h6>
                                <div class="documents-list">
                                    {% if row.id_docs %}
                                        <div class="document-category mb-3">
                                            <h6 class="category-title">
                                                <i class="fas fa-id-card text-primary"></i> Government ID
                                            </h6>
                                            <div class="document-items">
                                                {% for ev in row.id_docs %}
                                                <div class="document-item">
                                                    <div class="document-icon">
                                                        <i class="fas fa-file-pdf text-danger"></i>
                                                    </div>
                                                    <div class="document-info">
                                                        <span class="document-name">{{ ev.title }}</span>
                                                        <small class="text-muted">{{ ev.created_at|date:"M j, Y" }}</small>
                                                    </div>
                                                    <a href="{{ ev.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-download"></i> View
                                                    </a>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endif %}

                                    {% if row.selfies %}
                                        <div class="document-category mb-3">
                                            <h6 class="category-title">
                                                <i class="fas fa-user-circle text-info"></i> Selfie Photos
                                            </h6>
                                            <div class="document-items">
                                                {% for ev in row.selfies %}
                                                <div class="document-item">
                                                    <div class="document-icon">
                                                        <i class="fas fa-image text-success"></i>
                                                    </div>
                                                    <div class="document-info">
                                                        <span class="document-name">{{ ev.title }}</span>
                                                        <small class="text-muted">{{ ev.created_at|date:"M j, Y" }}</small>
                                                    </div>
                                                    <a href="{{ ev.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-eye"></i> View
                                                    </a>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endif %}

                                    {% if row.proofs %}
                                        <div class="document-category mb-3">
                                            <h6 class="category-title">
                                                <i class="fas fa-home text-warning"></i> Proof of Address
                                            </h6>
                                            <div class="document-items">
                                                {% for ev in row.proofs %}
                                                <div class="document-item">
                                                    <div class="document-icon">
                                                        <i class="fas fa-file-alt text-secondary"></i>
                                                    </div>
                                                    <div class="document-info">
                                                        <span class="document-name">{{ ev.title }}</span>
                                                        <small class="text-muted">{{ ev.created_at|date:"M j, Y" }}</small>
                                                    </div>
                                                    <a href="{{ ev.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-download"></i> View
                                                    </a>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        </div>
                                    {% endif %}

                                    {% if not row.id_docs and not row.selfies and not row.proofs %}
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle"></i> No documents uploaded
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No users found</h5>
                        <p class="text-muted">
                            {% if status == 'all' %}
                                No users have submitted verification requests yet.
                            {% else %}
                                No users with {{ status }} status found.
                            {% endif %}
                        </p>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Verification Action Confirmation Modal -->
<div class="modal fade" id="verificationActionModal" tabindex="-1" aria-labelledby="verificationActionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" id="modal-header">
                <h5 class="modal-title" id="verificationActionModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> <span id="modal-title-text">Confirm Action</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center mb-3">
                    <i class="fas fa-user-check fa-3x" id="modal-icon"></i>
                </div>
                <p class="text-center mb-0" id="modal-message">
                    Are you sure you want to perform this action?
                </p>
                <div class="alert alert-warning mt-3" id="modal-warning" style="display: none;">
                    <i class="fas fa-info-circle"></i>
                    <strong>Warning:</strong> This action cannot be undone.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn" id="confirmActionBtn">
                    <i class="fas fa-check"></i> <span id="confirm-btn-text">Confirm</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_head %}
<style>
/* Info Grid */
.info-grid {
    width: 100%;
}

.info-item {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    padding: 0.75rem;
    background: #f8f9fa;
    border-radius: 8px;
    border: 1px solid #e9ecef;
    height: 100%;
    transition: all 0.2s ease;
}

.info-item:hover {
    background: #e9ecef;
    transform: translateY(-1px);
}

.info-item strong {
    color: #6c757d;
    font-size: 0.875rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 0.25rem;
}

.info-item span {
    color: #212529;
    font-weight: 500;
    font-size: 0.95rem;
    word-wrap: break-word;
    overflow-wrap: break-word;
}

/* Document Categories */
.document-category {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    border: 1px solid #e9ecef;
}

.category-title {
    font-size: 0.875rem;
    font-weight: 600;
    color: #495057;
    margin-bottom: 0.75rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #dee2e6;
}

.document-items {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.document-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem;
    background: white;
    border-radius: 6px;
    border: 1px solid #dee2e6;
    transition: all 0.2s ease;
}

.document-item:hover {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transform: translateY(-1px);
}

.document-icon {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    border: 1px solid #dee2e6;
}

.document-info {
    flex: 1;
}

.document-name {
    display: block;
    font-weight: 500;
    color: #212529;
    margin-bottom: 0.25rem;
}

/* Card Header */
.card-header {
    background: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

/* Search functionality */
.search-card {
    transition: all 0.3s ease;
}

.search-card.hidden {
    display: none !important;
}

/* Search input styling */
.input-group-text {
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

#search-input:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

/* Search results animation */
.search-card {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .document-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .document-info {
        width: 100%;
    }
    
    .info-item {
        padding: 0.5rem;
    }
}
</style>
<script>
// Search functionality
document.addEventListener('DOMContentLoaded', function() {
    const input = document.getElementById('search-input');
    if (input) {
        // Add clear search functionality
        const clearButton = document.createElement('button');
        clearButton.type = 'button';
        clearButton.className = 'btn btn-outline-secondary btn-sm ms-2';
        clearButton.innerHTML = '<i class="fas fa-times"></i>';
        clearButton.title = 'Clear search';
        clearButton.style.display = 'none';
        
        // Add clear button to input group
        const inputGroup = input.closest('.input-group');
        if (inputGroup) {
            inputGroup.appendChild(clearButton);
        }
        
        input.addEventListener('input', () => {
            const query = input.value.toLowerCase().trim();
            
            // Show/hide clear button based on input
            if (query !== '') {
                clearButton.style.display = 'inline-block';
            } else {
                clearButton.style.display = 'none';
            }
            
            // Search through all cards
            const cards = document.querySelectorAll('.search-card');
            let visibleCount = 0;
            
            cards.forEach(card => {
                const keywords = (card.getAttribute('data-keywords') || '').toLowerCase();
                
                // Check if the query matches any part of the keywords
                if (query === '' || keywords.includes(query)) {
                    card.style.display = 'block';
                    card.style.opacity = '1';
                    card.style.transform = 'scale(1)';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                    card.style.opacity = '0.5';
                    card.style.transform = 'scale(0.95)';
                }
            });
            
            // Update the results count
            const countBadge = document.querySelector('.badge.bg-secondary');
            if (countBadge) {
                countBadge.textContent = `${visibleCount} user${visibleCount !== 1 ? 's' : ''}`;
            }
            
            // Show no results message if needed
            const noResultsCard = document.querySelector('.no-results-message');
            if (visibleCount === 0 && query !== '') {
                if (!noResultsCard) {
                    const noResults = document.createElement('div');
                    noResults.className = 'card no-results-message';
                    noResults.innerHTML = `
                        <div class="card-body text-center py-5">
                            <i class="fas fa-search fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">No users found</h5>
                            <p class="text-muted">No users match your search criteria.</p>
                        </div>
                    `;
                    const container = document.querySelector('.container .row .col-12');
                    container.appendChild(noResults);
                }
            } else if (noResultsCard) {
                noResultsCard.remove();
            }
        });
        
        clearButton.addEventListener('click', () => {
            input.value = '';
            input.dispatchEvent(new Event('input'));
        });
    }
});

// Handle verification actions with AJAX and modal
let currentActionData = null;

document.addEventListener('DOMContentLoaded', function() {
    const actionButtons = document.querySelectorAll('.verification-action-btn');
    
    actionButtons.forEach(button => {
        button.addEventListener('click', function() {
            const profileId = this.dataset.profileId;
            const action = this.dataset.action;
            const username = this.dataset.username;
            
            // Store current action data
            currentActionData = {
                profileId: profileId,
                action: action,
                username: username,
                button: this
            };
            
            // Show modal with appropriate content
            showVerificationModal(action, username);
        });
    });
    
    // Handle confirm action button
    document.getElementById('confirmActionBtn').addEventListener('click', function() {
        if (currentActionData) {
            performVerificationAction(currentActionData);
        }
    });
    
    // Clear current action data when modal is hidden
    document.getElementById('verificationActionModal').addEventListener('hidden.bs.modal', function() {
        currentActionData = null;
    });
});

function showVerificationModal(action, username) {
    const modal = document.getElementById('verificationActionModal');
    const modalHeader = document.getElementById('modal-header');
    const modalTitleText = document.getElementById('modal-title-text');
    const modalIcon = document.getElementById('modal-icon');
    const modalMessage = document.getElementById('modal-message');
    const modalWarning = document.getElementById('modal-warning');
    const confirmBtn = document.getElementById('confirmActionBtn');
    const confirmBtnText = document.getElementById('confirm-btn-text');
    
    if (action === 'approve') {
        // Approve action
        modalHeader.className = 'modal-header bg-success text-white';
        modalTitleText.textContent = 'Approve Verification';
        modalIcon.className = 'fas fa-check-circle fa-3x text-success';
        modalMessage.innerHTML = `Are you sure you want to <strong>approve</strong> <strong>${username}</strong>'s verification?`;
        modalWarning.style.display = 'none';
        confirmBtn.className = 'btn btn-success';
        confirmBtnText.textContent = 'Approve';
    } else {
        // Reject action
        modalHeader.className = 'modal-header bg-danger text-white';
        modalTitleText.textContent = 'Reject Verification';
        modalIcon.className = 'fas fa-times-circle fa-3x text-danger';
        modalMessage.innerHTML = `Are you sure you want to <strong>reject</strong> <strong>${username}</strong>'s verification?`;
        modalWarning.style.display = 'block';
        modalWarning.innerHTML = '<i class="fas fa-info-circle"></i><strong>Warning:</strong> This will delete all submitted documents and cannot be undone.';
        confirmBtn.className = 'btn btn-danger';
        confirmBtnText.textContent = 'Reject';
    }
    
    // Show the modal
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
}

function performVerificationAction(actionData) {
    const { profileId, action, username, button } = actionData;
    
    // Hide modal first
    const modal = bootstrap.Modal.getInstance(document.getElementById('verificationActionModal'));
    modal.hide();
    
    if (action === 'reject') {
        // For reject action, remove the card immediately
        const card = button.closest('.search-card');
        card.style.transition = 'all 0.3s ease';
        card.style.opacity = '0';
        card.style.transform = 'scale(0.95)';
        
        // Remove card after animation
        setTimeout(() => {
            card.remove();
            updateResultsCount();
        }, 300);
        
        // Show success message immediately
        showToast(`${username}'s verification was rejected and documents have been removed.`, 'info');
        
        // Make AJAX request in background without showing loading state
        fetch(`/users/user-verification/${profileId}/${action}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                // If there was an error, show it
                showToast(data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred while processing the verification.', 'error');
        });
    } else {
        // For approve action, show loading state
        const originalText = button.innerHTML;
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        
        // Make AJAX request
        fetch(`/users/user-verification/${profileId}/${action}/`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the card to show new status
                const card = button.closest('.search-card');
                card.style.opacity = '0.5';
                card.style.pointerEvents = 'none';
                
                // Update card content to show new status
                const cardHeader = card.querySelector('.card-header');
                const statusBadge = document.createElement('span');
                statusBadge.className = `badge bg-${data.verification_status === 'verified' ? 'success' : 'danger'} ms-2`;
                statusBadge.innerHTML = `<i class="fas fa-${data.verification_status === 'verified' ? 'check' : 'times'}"></i> ${data.verification_status.charAt(0).toUpperCase() + data.verification_status.slice(1)}`;
                cardHeader.querySelector('.d-flex').appendChild(statusBadge);
                
                // Show success message
                showToast(data.message, data.message_type);
                
                // Update results count
                updateResultsCount();
            } else {
                // Show error message
                showToast(data.message, 'error');
                
                // Re-enable button
                button.disabled = false;
                button.innerHTML = originalText;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('An error occurred while processing the verification.', 'error');
            
            // Re-enable button
            button.disabled = false;
            button.innerHTML = originalText;
        });
    }
}

// Function to show toast notifications
function showToast(message, type) {
    // Create toast element
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'info' ? 'info' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'info' ? 'info-circle' : 'exclamation-triangle'}"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    // Add toast to page
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // Show the toast
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement);
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

// Function to update results count
function updateResultsCount() {
    const visibleCards = document.querySelectorAll('.search-card:not([style*="none"])');
    const countBadge = document.querySelector('.badge.bg-secondary');
    if (countBadge) {
        countBadge.textContent = `${visibleCards.length} user${visibleCards.length !== 1 ? 's' : ''}`;
    }
}
</script>
{% endblock %}
